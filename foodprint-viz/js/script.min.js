/*! project-name v0.0.1 | (c) 2020 YOUR NAME | MIT License | http://link-to-your-git-repo.com */
const windowWidth=window.innerWidth,container=1200,padding=30,paddingLeft=0,width=document.getElementById("foodprint").offsetWidth,height=windowWidth>576?250:width/2+25,paddingCircles=1.5,maxRadius=15,radiusClustersCenters=150,colors=["#EC1C4B","#F16A43","#56BFBF","#A6206A","#BF7222"],meals=["breakfast","lunch","snack","dinner"],m=categories.length,color=d3.scaleSequential(d3.interpolateRainbow).domain(d3.range(m));let currentBreakfast="",currentLunch="",currentSnack="",currentDinner="",updatedMeal="",currentMenu="",isSwap=!1,instructionsShown=!1,latestMeal="",latestSwap="",currentSwap="",latestSwapedMeal="",currentSwapedMeal="",clusters=d3.range(m).map((e,t)=>{let a=0,r=0,s=0;switch(t){case 0:r=a=height-125,s=2*height-a;break;case 1:a=height-150,r=1.5*width/6,s=2.8*height/5;break;case 2:a=height-80,r=width/2,s=height;break;case 3:r=width-(a=height-125)-10,s=2*height-a;break;case 4:a=height-160,r=4.5*width/6,s=2.8*height/5}return{cluster:t,radius:15,r:a,x:r,y:s}}),nodes=[],newNodes=[];function appendSelectors(){meals.forEach(e=>{let t=[];menusDetail[e].forEach(e=>{const a={key:e.key,label:e.label};t.push(a)}),appendDropdown(windowWidth,e,t)})}function addMeal(e,t,a){switch(null!==document.querySelector(".tip.visible")&&""===updatedMeal&&d3.select(".tip").classed("visible",!1),latestMeal=updatedMeal,updatedMeal=e,currentMenu=a,e){case"breakfast":currentBreakfast=a;break;case"lunch":currentLunch=a;break;case"snack":currentSnack=a;break;case"dinner":currentDinner=a}let r=[];""!==t&&(r=getIngredients(e,t)),updateNodes(e,r,getIngredients(e,a)),addMealImpact(),setTimeout((function(){0!==document.querySelectorAll(".node.active").length||instructionsShown||(showSwapInstruction(),instructionsShown=!0)}),3e3)}function swapIngredient(e,t){hideSwapInstruction();let a={};menusDetail[e].forEach(e=>{let r=e.swaps.find(e=>e.key==t);void 0!==r&&(a=r)}),swapNodes(e,a),null!==document.querySelector("#dropdown--swap--"+e+" .option.reset.hidden")?d3.select("#dropdown--swap--"+e+" .option.reset.hidden").classed("hidden",!1):"reset"===t&&d3.select("#dropdown--swap--"+e+" .option.reset").classed("hidden",!0)}function updateNodes(e,t,a){if(t.length>0){let a=nodes;t.forEach(t=>{a=a.filter(a=>a.id!==t.id||a.meal!==e)}),nodes=a}a.length>0&&a.forEach(t=>{const a=getFoodprint(t.id);categories.forEach((r,s)=>{const n=Math.sqrt(parseFloat(a[r.label])*parseFloat(a.portion_kg)*r.factor/Math.PI),i={meal:e,id:t.id,label:t.label,cluster:r.cluster,radius:t.active?n:0,x:(s+1)*(width/6)+paddingLeft+Math.random(),y:height+Math.random(),appear:!1};nodes.push(i)})}),isSwap=!1,updateSimulation()}function swapNodes(e,t){latestSwap=currentSwap,currentSwap=t,latestSwapedMeal=currentSwapedMeal,currentSwapedMeal=e;let a="";switch(e){case"breakfast":a=currentBreakfast;break;case"lunch":a=currentLunch;break;case"snack":a=currentSnack;break;case"dinner":a=currentDinner}menusDetail[e].filter(e=>e.key===a)[0].ingredients.forEach(a=>{const r=getFoodprint(a.id);nodes.forEach(s=>{if(s.meal===e&&s.id===a.id)if(a.active||0===s.radius){if(a.active&&0===s.radius){const e=categories.filter(e=>e.cluster===s.cluster)[0];s.radius=Math.sqrt(parseFloat(r[e.label])*parseFloat(r.portion_kg)*e.factor/Math.PI),t.addedIngredients.some(e=>e.id===a.id)&&(s.appear=!0)}}else s.radius=0,s.appear=!1})}),t.removedIngredients.forEach(t=>{nodes.forEach(a=>{a.meal===e&&a.id===t.id&&(a.radius=0,a.appear=!1)})}),t.addedIngredients.forEach(t=>{const a=getFoodprint(t.id);nodes.forEach(r=>{if(r.meal===e&&r.id===t.id){const e=categories.filter(e=>e.cluster===r.cluster)[0];r.radius=Math.sqrt(parseFloat(a[e.label])*parseFloat(a.portion_kg)*e.factor/Math.PI),r.appear=!0}})}),isSwap=!0,updateSimulation()}appendSelectors(),showLegend();let svg=d3.select("#foodprint").append("svg").attr("id","foodprint").attr("class","foodprint-container").attr("height",2*height);windowWidth>1024&&d3.select(".swap-impact--container").style("height",2*height+"px");let arc=d3.arc(),circlesIndex=svg.append("g");circlesIndex.append("circle").attr("class","index-circle").attr("cx",width/2+paddingLeft).attr("cy",height).attr("r",0),circlesIndex.append("circle").attr("class","index-circle--external").attr("cx",width/2+paddingLeft).attr("cy",height).attr("r",()=>windowWidth>576?height-25:windowWidth/2-30);let circlesIndexTransformed=circlesIndex.append("g").attr("class","transformed").style("transform","translate("+(width/2+paddingLeft)+"px, "+height+"px)");circlesIndexTransformed.append("path").attr("id","index-circle--path").attr("d",e=>arc({startAngle:degreeToRadian(-90),endAngle:degreeToRadian(90),innerRadius:height-15,outerRadius:height-15})),circlesIndexTransformed.append("path").attr("id","index-circle--path--result").attr("d",e=>arc({startAngle:degreeToRadian(90),endAngle:degreeToRadian(270),innerRadius:height-5,outerRadius:height-5})),circlesIndexTransformed.append("text").attr("class","foodprint-index--label").style("text-anchor","middle").append("textPath").attr("xlink:href","#index-circle--path").attr("startOffset","25%").text("Foodprint Index").on("mouseover",e=>{d3.event.stopPropagation(),d3.selectAll(".foodprint-index--label").classed("active",!0),d3.select(".index-circle--external").classed("active",!0)}).on("click",e=>{d3.event.stopPropagation(),d3.select(".foodprint-index--label").classed("active-tooltip",!0),showCategoryTooltip("index")}).on("mouseout",e=>{d3.event.stopPropagation(),d3.selectAll(".foodprint-index--label").classed("active",!1),d3.select(".index-circle--external").classed("active",!1)}),circlesIndexTransformed.append("text").attr("class","foodprint-index--label foodprint-index--label--result").style("text-anchor","middle").append("textPath").attr("id","foodprint-result--number--index").attr("class","foodprint-result--number--index hidden").attr("xlink:href","#index-circle--path--result").attr("startOffset","75%").text(0),windowWidth>576&&(svg.append("g").attr("class","axis-circles--container").selectAll(".axis-circles").data(categories).enter().append("g").attr("class",e=>"axis-circles axis-circles--"+e.class),categories.forEach((e,t)=>{d3.select(".axis-circles--"+e.class).append("circle").attr("class","axis axis-circle axis-circle--"+e.class).attr("cx",clusters[e.cluster].x).attr("cy",clusters[e.cluster].y).attr("r",0),d3.select(".axis-circles--"+e.class).append("circle").attr("class","axis axis-circle--delimiter axis-circle--delimiter--"+e.class).attr("cx",clusters[e.cluster].x).attr("cy",clusters[e.cluster].y).attr("r",clusters[e.cluster].r);let a=d3.select(".axis-circles--"+e.class).append("g").attr("class","axis-paths-transformed").style("transform","translate("+clusters[e.cluster].x+"px, "+clusters[e.cluster].y+"px)");a.append("path").attr("id","category-label--path--"+e.class).attr("class","category-label--path").attr("d",t=>arc({startAngle:degreeToRadian(-120),endAngle:degreeToRadian(120),innerRadius:clusters[e.cluster].r+10,outerRadius:clusters[e.cluster].r+10})),a.append("path").attr("id","category-label--path--result--"+e.class).attr("class","category-label--path").attr("d",t=>arc({startAngle:degreeToRadian(90),endAngle:degreeToRadian(270),innerRadius:clusters[e.cluster].r-10,outerRadius:clusters[e.cluster].r-10})),a.append("path").attr("id","category-label--path--result--sup--"+e.class).attr("class","category-label--path").attr("d",t=>arc({startAngle:degreeToRadian(90),endAngle:degreeToRadian(270),innerRadius:clusters[e.cluster].r-8,outerRadius:clusters[e.cluster].r-8})),a.append("path").attr("id","category-label--path--result--sub--"+e.class).attr("class","category-label--path").attr("d",t=>arc({startAngle:degreeToRadian(90),endAngle:degreeToRadian(270),innerRadius:clusters[e.cluster].r-13,outerRadius:clusters[e.cluster].r-13})),a.append("text").attr("class","category-label").style("text-anchor","middle").append("textPath").attr("xlink:href","#category-label--path--"+e.class).attr("startOffset",t=>{switch(e.cluster){case 0:case 1:return"18%";case 2:return"25%";case 3:case 4:return"32%"}}).text(e.title).on("mouseover",t=>{d3.event.stopPropagation(),activeStyleCategory(e.class,!0)}).on("click",t=>{d3.event.stopPropagation(),handleCategoryClick(e.class,e.fact,e.source)}).on("mouseout",t=>activeStyleCategory(e.class,!1));let r=a.append("g").attr("class","axis-circles-text-container hidden").on("mouseover",t=>{d3.event.stopPropagation(),activeStyleCategory(e.class,!0)}).on("click",t=>{d3.event.stopPropagation(),handleCategoryClick(e.class,e.fact,e.source)}).on("mouseout",t=>activeStyleCategory(e.class,!1));r.append("text").attr("class","foodprint-result").style("text-anchor","end").append("textPath").attr("id","foodprint-result--number--"+e.class).attr("class","foodprint-result--number").attr("xlink:href","#category-label--path--result--"+e.class).attr("startOffset","76%").text(0);let s=r.append("text").attr("class","foodprint-result--dimension").style("text-anchor","start").append("textPath").attr("xlink:href","#category-label--path--result--"+e.class).attr("startOffset","76.5%"),n=r.append("text").attr("class","foodprint-result--dimension").style("text-anchor","start");switch(e.class){case"land":s.text(" m"),n.classed("superscript",!0).append("textPath").attr("xlink:href","#category-label--path--result--sup--"+e.class).attr("startOffset","578px").attr("baseline-shift","super").text("2");break;case"gas":s.text(" kgCO"),n.classed("subscript",!0).append("textPath").attr("xlink:href","#category-label--path--result--sub--"+e.class).attr("startOffset","454px").attr("baseline-shift","sub").text("2eq");break;case"water":s.text("L");break;case"eutro":s.text(" kgPO"),n.classed("subscript",!0).append("textPath").attr("xlink:href","#category-label--path--result--sub--"+e.class).attr("startOffset","574px").attr("baseline-shift","sub").text("4eq");break;case"cost":s.text("$")}}));let node=svg.append("g").selectAll("circle").attr("r",0),simulation=d3.forceSimulation();windowWidth<=576?simulation.force("x",d3.forceX().x(width/2).strength(1)).force("y",d3.forceY().y(width/2+30).strength(1)):simulation.force("x",d3.forceX().x(e=>clusters[e.cluster].x).strength(3)).force("cluster",d3.forceCluster().centers(e=>clusters[e.cluster]).strength(1)).force("y",d3.forceY().y(e=>clusters[e.cluster].y).strength(3)),simulation.force("collide",d3.forceCollide(e=>e.radius+1.5)).on("tick",layoutTick);const counters=document.querySelectorAll(".foodprint-result--number"),indexCounter=document.getElementById("foodprint-result--number--index");let currentFoodprintIndex=0;function updateSimulation(){function e(e,t){d3.event.stopPropagation(),t&&closeSwapImpact(),null!==document.querySelector(".tip.visible")&&hideSwapInstruction(),d3.selectAll(".node-"+e.meal+"-"+e.id).classed("active",!0),showTooltip(e)}(node=node.data(nodes)).exit().remove(),node=node.enter().append("circle").style("fill",e=>colors[e.cluster]).merge(node).on("mouseover",t=>{windowWidth>768&&e(t,!0)}).on("mouseout",e=>{windowWidth>768&&(function(e){d3.selectAll(".node-"+e.meal+"-"+e.id).classed("active",!1),hideTooltip(),null===document.querySelector("#tooltip-swap-impact.visible")&&d3.select("#tooltip-swap-impact").classed("visible",!0)})(e)}).on("click",t=>{windowWidth<=768&&(d3.selectAll(".node").classed("active",!1),e(t,!1))}),simulation.nodes(nodes),simulation.alpha(.02).restart();let t=[0,0,0,0,0],a=[0,0,0,0,0];if(nodes.forEach(e=>{t[e.cluster]+=Math.PI*Math.pow(e.radius,2),a[e.cluster]+=Math.PI*Math.pow(e.radius,2)/categories[e.cluster].factor}),updateFoodprint(a),!isSwap){let e=[0,0,0,0,0];switch(menusDetail[updatedMeal].find(e=>e.key===currentMenu).ingredients.filter(e=>e.active).forEach(t=>{const a=getFoodprint(t.id);e.forEach((t,r)=>{e[r]+=+a[categories[r].label]*a.portion_kg})}),updatedMeal){case"breakfast":foodprintBreakfast=e;break;case"lunch":foodprintLunch=e;break;case"snack":foodprintSnack=e;break;case"dinner":foodprintDinner=e}}const r=windowWidth>576?100:70*windowWidth/375;let s=parseFloat(getFoodprintIndex()),n=Math.sqrt(s/Math.PI);d3.select(".index-circle").attr("r",n*r*.4),animateNumber("foodprint-result--number--index",+indexCounter.innerHTML,s),isSwap&&"reset"!==currentSwap.key?calculateSwapImpact():isSwap&&"reset"===currentSwap.key&&hideSwapImpact(),windowWidth>576&&(d3.selectAll(".axis-circle").attr("r",(e,a)=>Math.sqrt(t[a]/Math.PI)),counters.forEach((e,t)=>{animateNumber(e.id,+e.innerHTML,+a[t].toFixed(2))})),currentFoodprintIndex=s}function layoutTick(){node.attr("cx",e=>e.x).attr("cy",e=>e.y).attr("r",e=>e.radius).attr("class",e=>{const t=e.appear?" appear":"";return"node node-"+e.meal+"-"+e.id+t})}function getIngredients(e,t){return menusDetail[e].find(e=>e.key===t).ingredients}function activeStyleCategory(e,t){d3.select(".axis-circles--"+e).classed("active",t)}function handleCategoryClick(e,t,a){d3.select(".axis-circles--"+e).classed("active-tooltip",!0),showCategoryTooltip(e,t,a)}function degreeToRadian(e){return e*Math.PI/180}